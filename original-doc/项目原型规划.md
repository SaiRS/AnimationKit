# 动作组件项目原型规划

## 更新日志：

1. 2017.9.21
   * 第一版草稿完成
2. 2017.9.

## 最终形态

### 目标：

> 编辑，打开，导出单个动作组件。

### 理解：

1. 代表一个动作对象。
2. 这个动作对象由一系列基本的元素构成：
   * 图片
   * 文本
   * 绘制的图形
   * 节点(用来表示空元素)
3. 这个动作对象可以有很多不同的动作。
4. 元素的属性的改变是构成动作的主要来源，对于元素可能有的属性，应该尽可能的支持属性对应的动作。
5. 为了能将这个动作对象在普通项目，动作组件项目（当前项目，需要打开正在编辑或者已经编辑好的动作对象），动作场景项目（下一个项目），需要提供一个加载器。这个加载器提供一个可选的parentContainer。可以直接按照配置文件去设置对象的属性，也可以修改对象的其他属性。

### 举例：

1. 飞翔的小鸟

   1. 翅膀
   2. 头部
   3. 身体
   4. 尾巴

   组合成一只小鸟，这只小鸟可以有多个动作

2. 点赞动作

## 实现思路：

### 动作对象

#### 动作对象

在实际存储中，动作对象是一系列资源，一个配置文件，以及可能的其他文件的集合，所以目录结构组织

```
--projectName
  --config.json
  --controller.js
  --res
    --img
    --style
    --video
```

其中配置文件(config.json)是记录动作对象的信息，控制文件(controller.js)是用来控制动作对象的行为，资源文件则是引用动作对象的资源。

#### 配置文件(config.json)

> 之前的设计从简单出发，规定ActionObject不能嵌套ActionObject对象。但这样子要实现表现一个魔法师召唤出一团火焰，要么就将魔法师和火焰当成一个动作对象（不好），要么就只能在下一个动作场景中通过组合方式来实现（不佳），所以还是提供ActionObject对象嵌套的能力。

##### 节点属性

###### property(属性)结构：

```Javascript
{
  type: '', // 属性的类型，用来解析value。
  name: '', // 属性的名字，用来正确设置属性，如对于js，可以通过object[name] = value来设置，或是其他可行的方法。
  value: ''  // 属性的值
}
```

###### Keyframe(关键帧)结构：

```Javascript
{
  <property>
    
  timeFunction: '', // 缓动动作，字符串，对于自定义的缓动动作，需要先进行注册
  time: '',  // 单位s  
  method: 'by/to/set', // 针对value, 是表示绝对，还是相对增量  
}
```

###### action property(动作属性)结构：

```Javascript
{
  type: '', // 属性的类型  
  keyframes: [
    <keyframe>,
    <keyframe>,
    ...
  ]
}
```

###### Full action property结构

```
{
  actionName: [
    <action property>,
    <action property>,
    ...
  ]
}
```

###### 全部结构

```javascript
{
  uuid: '', // 唯一标识符
  name: '', // 显示的名字  
  className：'', // 类名，可以用来提供当前对象新增的属性
  parentClassName：'', // 父类名称，可以用来提供父类所拥有的属性
  properties: [
    {
       type: '', // 属性类型
       value: '', // 属性的值
       name: '', // 属性的名字
    }
  ], // 属性
  actions: [
      {
          actionName : '',
          actionProperties: [
              {
                 type: '',
                 keyframes: [
                     {
                       time: '',
                       
                       type: '',
                       value: '',
                       name: '',
                       
                       timeFunction: '',
                       method: ''
                     }
                 ]
              }
          ]
      }
  ], // 动作属性  
  children: [], // 子元素
  version: '', // 版本信息
}
```

###### 示意图：

![](https://ws4.sinaimg.cn/large/006tKfTcly1fjia11dsgyj30sg0lc1kp.jpg)

![](https://ws3.sinaimg.cn/large/006tNc79ly1fjjd1lhmgej311w0xsaf3.jpg)

#### 控制文件(controller.js)

##### 加载

解析配置文件，主要任务是从配置文件中构建出Action Object对象。其中有一个Root Actor(XXDomNodeActor/XXDomNodeEditActor)，剩下的Actor则是这个Root Actor的直接子元素或者间接子元素。**之所以记录着么多Actor是因为在执行Action的时候，每一个元素都需要被当成一个Actor来对待**。

> 额外参数：同时考虑因为某些属性是百分比形式的，所以除了配置文件的路径之外，我们还会传入父节点的尺寸等额外参数。

> 可以提供一个父类，其他的controller继承这个父类，增加的主要有**变量**，**嵌套组件动作的执行**。

##### 显示

将解析后的所得到的所有Actor对象显示在界面上，因为有层级关系，在Actor的实现中，需要有返回自身的html片段的方法，同时也需要有添加，删除其他Actor的方法。

> 通过Actor的子类来具体实现，Actor基类只提供定义

##### 控制

控制action的运行，暂停等

> 因为我们已经可视化的编辑了Action，所以在使用上控制action的方法只需要简单的传入action name即可。
>
> 对象的动作，是各个元素动作的组合



```Javascript
class XXActionObjectController {

  
  constructor(configPath) {
    this._init(configPath);
    this._load();
  }

  // 执行action
  runActionWithName(actionName) {
    // ...
  }


  _init(configPath) {
    this._configPath = configPath; // 配置文件路径
    this._config = {} // 配置数据
  }

  _load() {
    
  }
}
```

### 编辑

#### 界面组成

##### ![](https://ws3.sinaimg.cn/large/006tNc79ly1fjnvra9tcaj31kw0wm1em.jpg)

由五部分组成(这个图是hype3的截图，我们制作的结构跟它相似，有些调整)

1. 工具栏。包括**插入(元素／组件)**，**成组／取消成组**，**前方／后方**，**锁定／解锁**，**检查器**，**资源**等其他工具。可以*配置显示的工具*。
2. 资源列表。显示的是**系统组件**，**自定义组件**，**资源**等用于构成组件元素所需要的资源。
3. 编辑区。可视化编辑组件的区域，由不同元素，组件构成，支持鼠标操作，支持键盘输入。
4. 动作编辑区。用于编辑元素的动作，提供预览，设置／切换动作，timeFunction，callback操作
5. 检查器。呈现项目的设置，元素的属性。可以通过输入改变元素的状态。子选项有**组件属性**，**度量属性**，**样式属性**，**字体属性**，**事件属性**，**物理量属性**，**身份属性**

```
// 结构
--App
  --ToolBar
  --StatusBar
  --ResourceInspector
  --ElementEditPanel
  --ActionEditPanel
  --PropertyInspector
```

#### 操作方式

##### 键盘输入

> 提供一个检查器，里边有关于项目的，文件的和元素的属性。编辑后实时更新在显示区的状态。
>
> 或是一些特殊的输入，如删除等。

##### 鼠标操作

针对于显示区的选中元素。操作有：**拖动**，**旋转**，**缩放**，**点选**，**框选**，**多选**，**鼠标右击**

#### 属性的修改

##### 单个对象属性修改

可以通过鼠标编辑方式或者检查器方式来修改

##### 多个对象的属性修改

对于多选的元素，可以同时修改其属性

### 导出

### 代码实现

#### 模块分类

* 系统模块
  * 导出设置
  * ​


* 项目模块
  * 新建模块：初始化一些必要的文件和文件夹。

    ```
    //
    --projectName
      --config.json(包含编辑信息和组件信息)
      --controller.js(控制文件)
      --kits(自定义组件文件夹)
      --res(资源文件夹)
        --img(图片文件夹)
        --audio(音频文件夹)
        --font(字体文件夹)
        --style(样式文件夹)
    ```

  * 打开(导入)模块：加载已经存在的组件。

    * 提供一系列读取配置的类
      * XXLoader
        * XXConfigLoader
        * XXObjectLoader
          * XXNodeLoader
          * ...
    * 针对文件中配置的的各个节点记录，生成对应的class(应该是XXNodeDomEditActor的子类，详见下文)
    * 修改基类XXNodeDomActor，使其可以添加／删除子元素，并可以添加到HTML页面中显示出来，留下接口，让子类完成相同的操作，并**监听事件**。

  * 保存模块：将修改保存到文件中。

    * 编辑时都是操作内存中对象的属性。
    * 保存时写入文件。

  * 导出模块：根据不同的配置，导出不同结果的文件。

    * 删除编辑有关的属性。
    * 将新的对象写入新的文件。

    ​

* 元素编辑模块

  - 增加基类XXNodeDomEditActor，继承自XXNodeDomActor，提供一些列用于鼠标操作的处理方法。

    ```
    // 可编辑状态
    canEditable()
    setEditable()

    // 选中状态
    isSelected()
    canSelected()

    // 处理相应鼠标事件
    click
    dbclick

    mouseenter
    mouseover
    mousemove
    mousedown
    mouseup
    mouseout
    mouseleave
    ```

  - 增加基本的元素的类，文字(XXNodeDomTextActor/XXNodeDomTextEditActor)，图片(XXNodeDomImageActor/XXNodeDomImageEditActor)。

  * 增加成组编辑元素XXNodeDomGroupEditActor，用于同时操作多个元素。

* 动作编辑模块

  * 时间线的表示
  * 关键帧的表示

* 操作记录模块

  * 定义一系列操作的命令和对应的参数
    * save
    * publish
    * copy
    * delete
    * ...
  * 两个堆栈

## 安排

1. 制作测试配置文件

   * 使用CocosBuilder提供的dragon demo中一些资源文件和对应的一些配置，修改称为我们所需要的配置文件

     | 任务               |      | 开始时间      | 结束时间      |      |
     | ---------------- | ---- | --------- | --------- | ---- |
     | - [x] 下载Dragon工程 |      | 2017.9.21 | 2017.9.21 |      |
     | - [ ] 修改Dragon工程 |      | 2017.9.22 | 2017.9.22 |      |
     |                  |      |           |           |      |

2. 操作反馈的UI

   * AlertView
   * ToastView

   提供一个通用的接口，实现部分使用第三方开源库。

   | 任务                |      | 开始时间      | 结束时间      |      |
   | ----------------- | ---- | --------- | --------- | ---- |
   | - [ ] 实现AlertView |      | 2017.9.23 | 2017.9.23 |      |
   | - [ ] 实现ToastView |      | 2017.9.23 | 2017.9.23 |      |
   |                   |      |           |           |      |

3. UI主界面编写
   * eletron的运行


   * 六个界面组件的显示
   * ResourceInspector可以显示资源列表文件
   * ​

| 任务   | 开始时间 | 结束时间 |
| ---- | ---- | ---- |
|      |      |      |
|      |      |      |
|      |      |      |

4. 读取文件并显示

5. 修改文件并保存

6. 导出文件并测试

## 重难点：

## 备注：

1. 需要图层？

   不需要。在这个项目中，只有一个根节点，剩下的元素按照顺序排列。也可以这么理解，一个项目的元素在同一图层上。

2. 粒子系统？

   ​

3. 两个动画中所操作的属性不一样，比如一个修改位置，一个修改缩放，那这两个动画切换时，对象的动作应该怎么办？

   * 先简单的用**当前状态**进行动画
   * 之后针对这种情况，可能会做一些额外的设置。

4. 3



* 注册edit和非edit元素之间的对应关系


* 注册timeFunction
* rotation旋转的属性考虑大于一圈的情况。

